#!/usr/bin/env bash

vagrant_dir="/vagrant"

source "${vagrant_dir}/scripts/colors.sh"
source "${vagrant_dir}/scripts/functions.sh"

get_config_value="/vagrant/scripts/get_config_value.sh"
magento_host_name=$(bash ${get_config_value} "magento_host_name")
use_nfs=$(bash "${vagrant_dir}/scripts/get_config_value.sh" "guest_use_nfs")
is_windows_host=${IS_WINDOWS_HOST}

declare -A setupOptions
setupOptions[admin_frontname]=$(bash ${get_config_value} "magento_admin_frontname")
setupOptions[language]=$(bash ${get_config_value} "magento_language")
setupOptions[timezone]=$(bash ${get_config_value} "magento_timezone")
setupOptions[currency]=$(bash ${get_config_value} "magento_currency")
setupOptions[admin_user]=$(bash ${get_config_value} "magento_admin_user")
setupOptions[admin_password]=$(bash ${get_config_value} "magento_admin_password")
setupOptions[db_host]='localhost'
setupOptions[db_name]='magento'
setupOptions[db_user]='root'
setupOptions[base_url]="http://${magento_host_name}/"
setupOptions[admin_lastname]='Admin'
setupOptions[admin_firstname]='Admin'
setupOptions[admin_email]='admin@example.com'
setupOptions[amqp_host]='localhost'
setupOptions[amqp_port]='5672'
setupOptions[amqp_user]='guest'
setupOptions[amqp_password]='guest'
setupOptions[amqp_virtualhost]='/'

if [[ ${is_windows_host} == 1 ]] || [[ ${use_nfs} == 0 ]]; then
    sudo chown -R vagrant:vagrant ${MAGENTO_ROOT}
fi

cd ${MAGENTO_ROOT}

status "Clearing cache"
m-clear-cache 2> >(logError) > >(log)

status "Removing Magento configuration files (env.php and config.php)"
rm -f "${MAGENTO_ROOT}/app/etc/config.php"
rm -f "${MAGENTO_ROOT}/app/etc/env.php"

db_names=(${setupOptions[db_name]} "magento_integration_tests" )
for db_name in "${db_names[@]}"; do
    status "Drop and create ${db_name} DB"
    mysql -e "drop database if exists ${db_name}; create database ${db_name};"
done

# Install Magento application
cd ${MAGENTO_ROOT}

install_cmd="./bin/magento setup:install \
    --db-host=${setupOptions[db_host]} \
    --db-name=${setupOptions[db_name]} \
    --db-user=${setupOptions[db_user]} \
    --backend-frontname=${setupOptions[admin_frontname]} \
    --base-url=${setupOptions[base_url]} \
    --language=${setupOptions[language]} \
    --timezone=${setupOptions[timezone]} \
    --currency=${setupOptions[currency]} \
    --admin-lastname=${setupOptions[admin_lastname]} \
    --admin-firstname=${setupOptions[admin_firstname]} \
    --admin-email=${setupOptions[admin_email]} \
    --admin-user=${setupOptions[admin_user]} \
    --admin-password=${setupOptions[admin_password]} \
    --cleanup-database \
    --use-rewrites=1"

# Configure Rabbit MQ
if [[ -f "${MAGENTO_ROOT}/app/etc/enterprise/di.xml" ]]; then
    install_cmd="${install_cmd} \
    --amqp-host=${setupOptions[amqp_host]} \
    --amqp-port=${setupOptions[amqp_port]} \
    --amqp-user=${setupOptions[amqp_user]} \
    --amqp-virtualhost=${setupOptions[amqp_virtualhost]} \
    --amqp-password=${setupOptions[amqp_password]}"
fi

sudo chmod +x bin/magento
status "Installing Magento"
statusLevel2 "${install_cmd}"
php ${install_cmd} 2> >(logError) > >(log)
# Comment out the line above and uncomment the one below to debug Magento Setup script
# php -d xdebug.remote_autostart=1 ${install_cmd} 2> >(logError) > >(log)

status "Configuring Varnish FPC according to config.yaml"
bash "${vagrant_dir}/scripts/guest/configure_varnish" -f 2> >(logError) > >(log)

status "Enabling Magento cron jobs"
echo "* * * * * php ${MAGENTO_ROOT}/bin/magento cron:run &
* * * * * php ${MAGENTO_ROOT}/update/cron.php &
* * * * * php ${MAGENTO_ROOT}/bin/magento setup:cron:run &" | crontab -u vagrant -

if [[ ${is_windows_host} == 1 ]] || [[ ${use_nfs} == 0 ]]; then
    status "Changing ownership of "${MAGENTO_ROOT}" to vagrant:vagrant"
    sudo chown -R vagrant:vagrant ${MAGENTO_ROOT}
fi

status "Configuring search engine according to config.yaml"
bash "${vagrant_dir}/scripts/guest/configure_search_engine"

status "Generating XSD references for PHP Storm"
php bin/magento dev:urn-catalog:generate /vagrant/.idea/misc.xml
sed -i "s|${MAGENTO_ROOT}|${MAGENTO_ROOT_HOST}|g" "/vagrant/.idea/misc.xml"

success "Magento reinstalled successfully"

info "Magento application was deployed to ${bold}${MAGENTO_ROOT}${regular} and installed successfully

Access storefront at ${bold}${setupOptions[base_url]}${regular}
Access admin panel at ${bold}${setupOptions[base_url]}${setupOptions[admin_frontname]}/${regular}"

